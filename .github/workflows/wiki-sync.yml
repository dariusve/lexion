name: Wiki Sync

on:
  push:
    branches:
      - main
    paths:
      - "docs/**"
      - "README.md"
      - ".github/workflows/wiki-sync.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Wiki Setting
        id: wiki-setting
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.get(context.repo);
            core.setOutput("enabled", data.has_wiki ? "true" : "false");

      - name: Fail if Wiki Is Disabled
        if: steps.wiki-setting.outputs.enabled != 'true'
        run: |
          echo "Repository wiki is disabled."
          echo "Enable it in GitHub: Settings -> General -> Features -> Wikis."
          exit 1

      - name: Prepare Wiki Repository
        env:
          WIKI_TOKEN: ${{ secrets.WIKI_TOKEN }}
          FALLBACK_GITHUB_TOKEN: ${{ github.token }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          token="${WIKI_TOKEN:-$FALLBACK_GITHUB_TOKEN}"
          wiki_url="https://x-access-token:${token}@${GITHUB_SERVER_URL#https://}/${GITHUB_REPOSITORY}.wiki.git"

          if ! git ls-remote "$wiki_url" >/dev/null 2>&1; then
            echo "Wiki repository is not reachable."
            echo "1) Ensure Wiki is enabled in repo settings."
            echo "2) Create the first wiki page manually in the GitHub Wiki UI."
            echo "3) For private repos, add a WIKI_TOKEN secret (PAT with repo scope)."
            exit 1
          fi

          git clone "$wiki_url" wiki

      - name: Sync Markdown Content
        run: |
          find wiki -mindepth 1 -maxdepth 1 -type f -name "*.md" -delete
          cp docs/*.md wiki/
          cp README.md wiki/Project-README.md
          if [ -f "wiki/LEXION_OVERVIEW.md" ]; then
            cp wiki/LEXION_OVERVIEW.md wiki/Home.md
          fi

      - name: Commit and Push
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No wiki changes."
            exit 0
          fi
          git commit -m "docs: sync wiki from main"
          git push
